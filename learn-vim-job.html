<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" xml:lang="zh">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="learn-vi.css" />
	<title>VIM学习笔记 作业(job)</title>
</head>
<body>
	<h1>VIM学习笔记 作业(job)</h1>

	<h2 class="article"><a id=""></a></h2>
	<p></p>
	<a href="#" title=""></a>
	<p>自8.0版本起，包含+channel和+job特性的Vim将可以支持异步操作。Vim使用作业（job）来启动进程，并利用通道（channel）和其他进程通信。</p>
	<p>利用异步支持，可以在后台进行复杂耗时的操作（比如使用外部<a href="http://yyq123.github.io/learn-vim/learn-vim-Regex.html" title="">grep</a>工具查找文本），不必等待外部命令结束即可返回Vim，而不中断前台的正常编辑。在外部命令结束运行时，可以通过回调函数来处理执行结果。</p>
	<p><a href="https://yyq123.github.io/learn-vim/images/job_start_version.png" title="job_start_version"><img src="https://yyq123.github.io/learn-vim/images/job_start_version.png" alt="job_start_version" width="550" height="515" /></a></p>

	<p>例如使用以下外部命令，来列示目录内容：</p>
	<p style="text-indent:2em"><code class="inset">:!ls</code></p>
	<p>与在 shell 中执行几乎是一样的，只是将输出 打印到终端，供用户交互时查看。</p>
	<p style="text-indent:2em"><code class="inset"></code></p>

	<h2 class="article"><a id=job-start">启动作业</a></h2>
	<p>使用以下job_start()函数，可以异步执行命令：</p>
	<p style="text-indent:2em"><code class="inset">job_start({command} [, {options}])</code></p>
	<p>其中：<var>command</var>，用于指定需要运行的外部系统命令；<var>options</var>，是包含多个键值的字典选项，用于配置或控制作业的行为。</p>

	<h2 class="article"><a id=out_cb">捕获输出</a></h2>
	<p>首先定义回调函数（callback，缩写为cb）：</p>
	<pre class="block"><code>func! MyHandler (channel, msg)
    echomsg 'From the handler:' . a:msg
endfunc </code></pre>
	<p>然后通过"out_cb"选项，指定回调函数来处理stdout的内容：</p>
	<p style="text-indent:2em"><code class="inset">let job = job_start(command, {"out_cb": "MyHandler"})</code></p>
	<p>如果不需要处理命令执行中的输出，而只希望处理命令结束时的输出，那么可以指定"close_cb"选项</p>
	<pre class="block"><code>func! CloseHandler (channel)
while ch_status (a:channel, {"part":"out"}) == "buffered"
    echomsg ch_read (a:channel)
endwhile
endfunc</code></pre>
	<p style="text-indent:2em"><code class="inset">let job = job_start(command, {"close_cb": "CloseHandler"})</code></p>


	<p></p>
Or you can usech_read (job) orcd_readraw (job) Read the output generated by the job
	<p>一个是 OnWrking() 在工作进行时调用，每当所执行的任务有输出时就会被调用， 输出会通过第二参数传入回调函数；另一个是 DoneWork() ，在工作完成时调用。当然 应该知道，这两个函数名是我们任意自定义的，名字不重要，关键的魔法是键名， callback 与 close_cb 标识了对应的函数（引用）在适当的机会被调用。</p>
并非每次 job_start() 启动任务都得注册这两个回调，根据实际 工作任务情况可在其中一个（或更多）回调函数中处理感兴趣的信息。甚至如果只是想让 某个外部命令在后台默默运行，不关心任何反馈的话，也可以不注册任何回调函数。只不过提供回调的话，会使异步任务更有交互感与确 认感，让用户知道后台命令确实在执行了。
	一般来说，任务的选项是要在启动时设置，但也有些选项可以在启动之后，还处于 run 状态时，使用 job_setoptions() 补充选项。

	<p>使用以下命令，可以将输出重定向到指定缓冲区：</p>
	<p style="text-indent:2em"><code class="inset">:let job = job_start('ls -alh', {'out_io': 'buffer', 'out_name': 'mybuffer'})</code></p>
	<p>使用以下命令，则可以打开缓冲区：</p>
	<p style="text-indent:2em"><code class="inset">:sbuf mybuffer</code></p>
	<p></p>
	<p style="text-indent:2em"><code class="inset">:call job_start(["/bin/sh", "-c", "ls -al &gt; /tmp/file.txt"])</code></p>
	<p>启<a href="http://httpd.apache.org/" title="Apache HTTP Server">Apache HTTP Server</a></p>
	<p style="text-indent:2em"><code class="inset">:let job = job_start('apachectl start')</code></p>
	<p>使用以下命令，即可以载入首页的内容：</p>
	<p style="text-indent:2em"><code class="inset">:silent r ! curl localhost</code></p>

	<h2 class="article"><a id=job-status">作业状态</a></h2>
	<p>取得对应的通道: </p>
	<p style="text-indent:2em"><code class="inset">let channel = job_getchannel(job)</code></p>

	<h2 class="article"><a id=job-status">作业状态</a></h2>
	<p>使用job_status()函数，可以返回指定任务的状态：</p>
	<p style="text-indent:2em"><code class="inset">:echo job_status(job)</code></p>
                        "run"   作业运行中
                        "fail"  作业无法启动
                        "dead"  作业启动后结束或被终止
	<p>使用job_info()函数，则可返回指定任务的详细信息：</p>
	<p style="text-indent:2em"><code class="inset">:echo job_info(job)</code></p>
               返回关于 {job} 信息的字典:
                   "status"      job_status()  返回值
                   "channel"     job_getchannel()  返回值
                   "cmd"        启动作业的命令行参数列表
                   "process"    进程 ID
                   "tty_in"     终端输入名，如果没有则为空
                   "tty_out"    终端输出名，如果没有则为空
                   "exitval"    "status" 为 "dead" 时才有效
                   "exit_cb"    退出时调用的函数
                   "stoponexit"  job-stoponexit 

                   仅用于 Unix:
                   "termsig"    终止程序的信号 (相关值见  job_stop() )
                                仅当 "status" 为 "dead" 时才有意义

                   仅用于 MS-Windows:
                   "tty_type"   使用的虚拟控制台类型。
                                可选值是 "winpty" 或 "conpty"。
                                见 'termwintype'。

	<h2 class="article"><a id=job-stop">停止作业</a></h2>
	<p style="text-indent:2em"><code class="inset">:call job_stop(job)</code></p>
function! s:on_find(chan, msg)
  lgetexpr split(a:msg, '')
endfunction

call job_start('find . -print0', {
      \ 'out_mode': 'raw',
      \ 'callback': function('<SID>on_find')
      \ })

HTTP response.

function! s:on_line(chan, msg)
  if empty(a:msg)
    let body = "Hello from Vim!"
    call ch_sendraw(a:chan, join([
          \ "HTTP/1.1 200 OK",
          \ "Content-Length: " . len(body),
          \ "Content-Type: text/plain",
          \ "",
          \ body
          \ ], "\n"))
  endif
endfunction

" Save reference to long-running job or it will be garbage collected
let server = call job_start('nc -lp 3000', {
      \ 'callback': function('<SID>on_line'),
      \ 'in_mode': 'raw',
      \ 'out_mode': 'nl'
      \ })
	<p><a href="https://yyq123.github.io/learn-vim/images/.png" title=""><img src="https://yyq123.github.io/learn-vim/images/.png" alt="" width="500" height="" /></a></p>
https://github.com/skywind3000/asyncrun.vim
	<p style="color:gray; font-size:0.6em"><a href="http://yyq123.github.io/learn-vim/images/.png" title=""><img src="http://yyq123.github.io/learn-vim/images/.png" alt="" /></a></br>Source: medium.com/free-code-camp</p>

	<pre class="block">
	</pre>
	<p style="text-indent:2em"><code class="inset">:help job</code></p>

	<ul>
		<li><p class="item"><br /></p></li>
		<li><p class="item"><a href="#" title=""></a><br /></p></li>
	</ul>

	<span style="font-weight:bold; color:#4169E1; margin-left:0.2em">&#65311;</span>

	<table summary="Commands" border="1" frame="border" rules="all" cellspacing="0" cellpadding="3">
		<caption style="margin:0.5em; font-weight:bold">选项列表</caption>
		<thead>
		<tr><th style="white-space: nowrap">选项</th><th>描述</th><th>帮助信息</th></tr>
		</thead>
		<tbody>
		<tr><td><code class="inset">!</code></td><td>如果包含，表示。例如，。</td><td style="white-space: nowrap"><code class="inset">:help viminfo-!</code></td></tr>
		</tbody>
	</table>

	<table summary="Commands" border="2" frame="hsides" rules="all" cellspacing="0" cellpadding="3">
		<caption>命令小结</caption>
		<tbody>
		<tr><td><code class="inset">:</code></td><td rowspan="2"></td></tr>
		<tr><td><code class="inset">:</code></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
		</tbody>
	</table>
&ldquo;&rdquo;

	<p style="border-top:1px solid lightgray"><span style="float:right">Ver: 2.0&nbsp;|&nbsp;<a href="mailto:yyq123@gmail.com">YYQ</a></span><span>&lt;<a title="" href="http://yyq123.github.io/learn-vim/.html">上一篇</a>&nbsp;|<a title="笔记列表" href="http://yyq123.github.com/learn-vim/learn-vi-00-00-TOC.html">&nbsp;目录&nbsp;</a>|&nbsp;<a title="" href="http://yyq123.github.io/learn-vim/.html">下一篇</a>&gt;</span></p>

</body>
</html>
